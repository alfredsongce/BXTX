# BattleSceneåŠŸèƒ½è¿ç§»è®¡åˆ’

## æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•äº† `BattleScene.gd` ä¸­éœ€è¦è¿ç§»çš„æ ¸å¿ƒåŠŸèƒ½å‡½æ•°ï¼Œä»¥åŠå®ƒä»¬çš„ç›®æ ‡è¿ç§»æ¨¡å—ã€‚å½“å‰ `BattleScene.gd` çº¦æœ‰2151è¡Œä»£ç ï¼Œç»è¿‡å‰æœŸä¼˜åŒ–å·²ç»å®Œæˆäº†UIç®¡ç†ã€æŠ€èƒ½é€‰æ‹©åè°ƒã€ç§»åŠ¨ç³»ç»Ÿã€æˆ˜æ–—æµç¨‹ç®¡ç†ã€è¾“å…¥å¤„ç†å’ŒåŠ¨ç”»è§†è§‰æ•ˆæœç®¡ç†çš„åˆ†ç¦»ã€‚

## å·²å®Œæˆçš„è¿ç§»é˜¶æ®µ

### âœ… é˜¶æ®µ1: UIç®¡ç†åˆ†ç¦»
- **ç›®æ ‡æ¨¡å—**: `BattleUIManager.gd`
- **çŠ¶æ€**: å·²å®Œæˆ

### âœ… é˜¶æ®µ2: æŠ€èƒ½é€‰æ‹©åè°ƒåˆ†ç¦»
- **ç›®æ ‡æ¨¡å—**: `SkillSelectionCoordinator.gd`
- **çŠ¶æ€**: å·²å®Œæˆ

### âœ… é˜¶æ®µ3: ç§»åŠ¨ç³»ç»Ÿåˆ†ç¦»
- **ç›®æ ‡æ¨¡å—**: `MovementCoordinator.gd`
- **çŠ¶æ€**: å·²å®Œæˆ

### âœ… é˜¶æ®µ4: æˆ˜æ–—æµç¨‹ç®¡ç†åˆ†ç¦»
- **ç›®æ ‡æ¨¡å—**: `BattleFlowManager.gd`
- **çŠ¶æ€**: å·²å®Œæˆ

### âœ… é˜¶æ®µ5: è¾“å…¥å¤„ç†åˆ†ç¦»
- **ç›®æ ‡æ¨¡å—**: `BattleInputHandler.gd`
- **çŠ¶æ€**: å·²å®Œæˆ

### âœ… é˜¶æ®µ6: åŠ¨ç”»å’Œè§†è§‰æ•ˆæœç®¡ç†åˆ†ç¦»
- **ç›®æ ‡æ¨¡å—**: `BattleAnimationManager.gd` å’Œ `BattleVisualEffectsManager.gd`
- **çŠ¶æ€**: å·²å®Œæˆ

## å¾…è¿ç§»åŠŸèƒ½æ¸…å•

### âœ… é˜¶æ®µ7: æˆ˜æ–—æ‰§è¡Œé€»è¾‘è¿ç§»
**ç›®æ ‡æ¨¡å—**: `BattleCombatManager.gd`
**çŠ¶æ€**: å·²å®Œæˆ
**é¢„è®¡ä»£ç è¡Œæ•°**: ~300è¡Œ

#### å·²è¿ç§»çš„å‡½æ•°:
1. **æ”»å‡»æ‰§è¡Œç›¸å…³**
   - âœ… `_execute_attack(attacker, target, skill_data)` (è¡Œ 1300-1350)
   - âœ… `_calculate_damage(attacker, target, skill_data)` (è¡Œ 1350-1380)
   - âœ… `_apply_damage(target, damage)` (è¡Œ 1380-1400)
   - âœ… `_display_attack_targets(targets)` (è¡Œ 1200-1220) - è¿ç§»è‡³UIç®¡ç†å™¨
   - âœ… `_get_enemy_targets(character)` (è¡Œ 1220-1240) - è¿ç§»è‡³UIç®¡ç†å™¨
   - âœ… `_highlight_targets(targets)` (è¡Œ 1240-1260) - è¿ç§»è‡³UIç®¡ç†å™¨
   - âœ… `_clear_target_highlights()` (è¡Œ 1260-1280) - è¿ç§»è‡³UIç®¡ç†å™¨
   - âœ… `_cancel_attack()` (è¡Œ 1450-1470)

2. **è§’è‰²æ­»äº¡å¤„ç†**
   - âœ… `_handle_character_death(character)` (è¡Œ 1400-1450)
   - âœ… `_DeathMarkerDrawer` ç±» (è‡ªå®šä¹‰æ­»äº¡æ ‡è®°ç»˜åˆ¶å™¨)

3. **æˆ˜æ–—ç»“æœæ£€æŸ¥**
   - âœ… `_check_victory_condition()` (è¡Œ 2100-2130)
   - âœ… `_test_victory_condition()` (è¡Œ 2130-2151)

### âœ… é˜¶æ®µ8: AIè¡ŒåŠ¨ç®¡ç†ä¼˜åŒ–
**ç›®æ ‡æ¨¡å—**: `BattleAIManager.gd` (ä¼˜åŒ–ç°æœ‰)
**çŠ¶æ€**: å·²å®Œæˆ
**é¢„è®¡ä»£ç è¡Œæ•°**: ~200è¡Œ

#### å·²è¿ç§»/ä¼˜åŒ–çš„å‡½æ•°:
1. **AIå®Œæ•´å›åˆæ‰§è¡Œ**
   - âœ… `_execute_complete_ai_turn(character)` (è¡Œ 1900-2000) - å·²å§”æ‰˜ç»™BattleAIManager
   - âœ… `_ai_try_move_silent(character)` (è¡Œ 2000-2050) - å·²å§”æ‰˜ç»™BattleAIManager
   - âœ… `_ai_try_attack_silent(character)` (è¡Œ 2050-2100) - å·²å§”æ‰˜ç»™BattleAIManager

2. **AIè¡ŒåŠ¨åè°ƒ**
   - âœ… `_execute_ai_action(character)` (è¡Œ 1100-1150) - å·²å§”æ‰˜ç»™BattleAIManager
   - âœ… AIè¡ŒåŠ¨ç‚¹ç®¡ç†å’ŒåŒæ­¥é€»è¾‘ - å·²å®ç°å®Œæ•´çš„AIå†³ç­–ç³»ç»Ÿ

#### è¿ç§»æˆæœ:
- âœ… `BattleAIManager.gd` å·²å®Œæ•´å®ç°ï¼ŒåŒ…å«479è¡Œä»£ç 
- âœ… å®ç°äº†å®Œæ•´çš„AIå†³ç­–ç³»ç»Ÿã€ç­–ç•¥åˆ†æã€è¡ŒåŠ¨æ‰§è¡Œç­‰åŠŸèƒ½
- âœ… BattleScene.gdä¸­çš„AIå‡½æ•°å·²æ”¹ä¸ºå§”æ‰˜è°ƒç”¨ï¼Œä¿æŒå‘åå…¼å®¹æ€§
- âœ… ä¿ç•™äº†å¿…è¦çš„è¾…åŠ©å‡½æ•°ç”¨äºåœºæ™¯çº§åˆ«çš„åè°ƒ

### âœ… é˜¶æ®µ9: æˆ˜æ–—äº‹ä»¶å¤„ç†è¿ç§»
**ç›®æ ‡æ¨¡å—**: `BattleFlowManager.gd` (æ‰©å±•ç°æœ‰) å’Œ `BattleEventManager.gd` (æ–°å»º)
**çŠ¶æ€**: å·²å®Œæˆ
**å®é™…ä»£ç è¡Œæ•°**: ~200è¡Œ

#### å·²è¿ç§»çš„å‡½æ•°:
1. **æŠ€èƒ½ç³»ç»Ÿå›è°ƒ**
   - âœ… `_on_skill_execution_completed(result)` (è¡Œ 1340-1360) - å·²å§”æ‰˜ç»™BattleEventManager
   - âœ… `_on_skill_cancelled()` (è¡Œ 1340-1360) - å·²å§”æ‰˜ç»™BattleEventManager
   - âœ… `_on_visual_skill_cast_completed(skill, caster, targets)` (è¡Œ 1489-1513) - å·²å§”æ‰˜ç»™BattleEventManager
   - âœ… `_on_visual_skill_selection_cancelled()` (è¡Œ 1514-1548) - å·²å§”æ‰˜ç»™BattleEventManager

2. **è§’è‰²è¡ŒåŠ¨å®Œæˆå¤„ç†**
   - âœ… `_on_character_action_completed()` (è¡Œ 790-810) - å·²å§”æ‰˜ç»™BattleEventManager
   - âœ… `_proceed_to_next_character()` (è¡Œ 1041-1061) - å·²å§”æ‰˜ç»™BattleEventManager

3. **ç§»åŠ¨å’ŒåŠ¨ç”»å›è°ƒ**
   - âœ… `_on_move_animation_completed(character_data, new_position)` (è¡Œ 945-965) - å·²å§”æ‰˜ç»™BattleEventManager

#### è¿ç§»æˆæœ:
- âœ… åˆ›å»ºäº†æ–°çš„ `BattleEventManager.gd` æ¨¡å—ï¼ŒåŒ…å«å®Œæ•´çš„äº‹ä»¶å¤„ç†ç³»ç»Ÿ
- âœ… æ‰©å±•äº† `BattleFlowManager.gd`ï¼Œæ·»åŠ äº†æˆ˜æ–—äº‹ä»¶ä¿¡å·å’Œå¤„ç†å‡½æ•°
- âœ… BattleScene.gdä¸­çš„äº‹ä»¶å¤„ç†å‡½æ•°å·²æ”¹ä¸ºå§”æ‰˜è°ƒç”¨ï¼Œä¿æŒå‘åå…¼å®¹æ€§
- âœ… å®ç°äº†äº‹ä»¶é˜Ÿåˆ—ç³»ç»Ÿï¼Œæ”¯æŒå¼‚æ­¥äº‹ä»¶å¤„ç†å’Œä¼˜å…ˆçº§ç®¡ç†

### ğŸ”„ é˜¶æ®µ10: è¾…åŠ©åŠŸèƒ½æ•´ç†
**ç›®æ ‡æ¨¡å—**: åˆ†æ•£åˆ°å„ä¸ªç›¸å…³æ¨¡å—
**é¢„è®¡ä»£ç è¡Œæ•°**: ~100è¡Œ

#### éœ€è¦è¿ç§»çš„å‡½æ•°:
1. **è§’è‰²æŸ¥æ‰¾å’Œç®¡ç†**
   - `_find_character_node_by_data(character_data)` (è¡Œ 900-950)
   - `get_all_characters()` (è¡Œ 1750-1770) - å·²å§”æ‰˜ç»™ character_manager

2. **UIçŠ¶æ€ç®¡ç†**
   - `_on_ui_update_requested()` (è¡Œ 1850-1870)
   - `_update_battle_button_state()` (è¡Œ 1870-1890)
   - `_force_close_all_player_action_menus()` (è¡Œ 1920-1940)

3. **å·¥å…·å‡½æ•°**
   - `_join_string_array(arr, separator)` (è¡Œ 1940-1950)
   - å„ç§æµ‹è¯•å’Œè°ƒè¯•å‡½æ•°

## è¿ç§»ä¼˜å…ˆçº§

### âœ… å·²å®Œæˆçš„é«˜ä¼˜å…ˆçº§é˜¶æ®µ
1. âœ… **é˜¶æ®µ7: æˆ˜æ–—æ‰§è¡Œé€»è¾‘è¿ç§»** - æ ¸å¿ƒæˆ˜æ–—åŠŸèƒ½ï¼Œå½±å“æ¸¸æˆä¸»è¦ç©æ³•
2. âœ… **é˜¶æ®µ8: AIè¡ŒåŠ¨ç®¡ç†ä¼˜åŒ–** - AIç³»ç»Ÿä¼˜åŒ–ï¼Œæå‡æ¸¸æˆä½“éªŒ
3. âœ… **é˜¶æ®µ9: æˆ˜æ–—äº‹ä»¶å¤„ç†è¿ç§»** - äº‹ä»¶æµç¨‹ç®¡ç†ï¼Œç¡®ä¿ç³»ç»Ÿåè°ƒæ€§

### å‰©ä½™ä¼˜å…ˆçº§ (åç»­æ‰§è¡Œ)
4. **é˜¶æ®µ10: è¾…åŠ©åŠŸèƒ½æ•´ç†** - ä»£ç æ¸…ç†ï¼Œæå‡ç»´æŠ¤æ€§

## é¢„æœŸæˆæœ

å®Œæˆæ‰€æœ‰è¿ç§»åï¼Œ`BattleScene.gd` é¢„è®¡å°†ä»å½“å‰çš„ ~2151è¡Œ å‡å°‘åˆ° ~800-1000è¡Œï¼Œä¸»è¦ä¿ç•™:
- åœºæ™¯åˆå§‹åŒ–å’Œé…ç½®
- å„ç®¡ç†å™¨çš„åè°ƒè°ƒç”¨
- æ ¸å¿ƒçš„åœºæ™¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
- å¿…è¦çš„GodotèŠ‚ç‚¹æ“ä½œ

## è¿ç§»åŸåˆ™

1. **å•ä¸€èŒè´£**: æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ç‰¹å®šçš„åŠŸèƒ½é¢†åŸŸ
2. **æ¾è€¦åˆ**: æ¨¡å—é—´é€šè¿‡ä¿¡å·å’Œæ¥å£é€šä¿¡ï¼Œå‡å°‘ç›´æ¥ä¾èµ–
3. **GodotèŠ‚ç‚¹è®¾è®¡**: å……åˆ†åˆ©ç”¨Godotçš„èŠ‚ç‚¹ç³»ç»Ÿå’Œä¿¡å·æœºåˆ¶
4. **å‘åå…¼å®¹**: ç¡®ä¿è¿ç§»è¿‡ç¨‹ä¸­ä¸ç ´åç°æœ‰åŠŸèƒ½
5. **æ¸è¿›å¼é‡æ„**: åˆ†é˜¶æ®µè¿›è¡Œï¼Œæ¯ä¸ªé˜¶æ®µéƒ½èƒ½ç‹¬ç«‹æµ‹è¯•å’ŒéªŒè¯

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

âœ… **å·²å®Œæˆçš„ä¸»è¦è¿ç§»é˜¶æ®µ**: é˜¶æ®µ1-9å·²å…¨éƒ¨å®Œæˆï¼ŒåŒ…æ‹¬UIç®¡ç†ã€æŠ€èƒ½é€‰æ‹©åè°ƒã€ç§»åŠ¨ç³»ç»Ÿã€æˆ˜æ–—æµç¨‹ç®¡ç†ã€è¾“å…¥å¤„ç†ã€åŠ¨ç”»è§†è§‰æ•ˆæœç®¡ç†ã€æˆ˜æ–—æ‰§è¡Œé€»è¾‘ã€AIè¡ŒåŠ¨ç®¡ç†å’Œæˆ˜æ–—äº‹ä»¶å¤„ç†çš„è¿ç§»ã€‚

ğŸ”„ **å½“å‰çŠ¶æ€**: è¿›å…¥ **é˜¶æ®µ10: è¾…åŠ©åŠŸèƒ½æ•´ç†**ï¼Œä¸»è¦è¿›è¡Œä»£ç æ¸…ç†å’Œç»´æŠ¤æ€§æå‡å·¥ä½œã€‚

ğŸ“‹ **å»ºè®®åç»­å·¥ä½œ**:
1. å¯¹å„ä¸ªè¿ç§»æ¨¡å—è¿›è¡Œå…¨é¢æµ‹è¯•ï¼Œç¡®ä¿åŠŸèƒ½æ­£å¸¸
2. å®Œæˆé˜¶æ®µ10çš„è¾…åŠ©åŠŸèƒ½æ•´ç†å·¥ä½œ
3. è¿›è¡Œæ€§èƒ½ä¼˜åŒ–å’Œä»£ç é‡æ„
4. æ›´æ–°ç›¸å…³æ–‡æ¡£å’Œæ³¨é‡Š