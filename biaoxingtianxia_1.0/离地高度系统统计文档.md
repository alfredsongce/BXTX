# 离地高度系统统计文档
# 离地高度系统统计文档

## 概述

本文档统计了项目中所有与离地高度相关的代码位置、功能和实现细节。离地高度系统是游戏中轻功移动的核心机制，涉及多个组件的协同工作。

## 1. 核心配置文件

### MoveRangeConfig.gd
**文件路径**: `Scripts/MoveRangeDisplay/MoveRangeConfig.gd`

**高度相关配置**:
- `ground_height_offset: int = 30` - 角色踩在地面上的固定高度偏移（像素）

**关键函数**:
- `set_ground_height_offset(offset: int)` - 设置地面高度偏移
- `get_ground_height_offset() -> int` - 获取地面高度偏移

**已删除的配置和函数**:
- ~~`flight_height_multiplier`~~ - 轻功飞行高度倍数（已删除）
- ~~`min_flight_height`~~ - 最小轻功飞行高度（已删除）
- ~~`max_flight_height`~~ - 最大轻功飞行高度（已删除）
- ~~`get_effective_height_limit()`~~ - 返回固定的地面高度偏移（已删除）
- ~~`get_flight_height()`~~ - 获取轻功飞行高度（已删除）

## 2. 位置碰撞管理器

### PositionCollisionManager.gd
**文件路径**: `Scripts/PositionCollisionManager.gd`

**地面检查函数**:
1. `_check_ground_limit_comprehensive(target_position, char_ground_y)` (行426)
   - 地面限制检查，确保不移动到地面以下

**已删除的高度检查函数**:
- ~~`_validate_height_limit()`~~ - 详细的高度限制验证（已删除）
- ~~`_check_height_limit_comprehensive()`~~ - 简化版高度限制检查（已删除）

**GroundAnchor相关**:
- `_get_ground_anchor_position(target_position, character)` (行368)
- 默认GroundAnchor偏移: `Vector2(0, 22)`

**四重验证逻辑** (行140-180):
1. 圆形范围检查
2. 地面检查 (行167)
3. 角色障碍物碰撞检查
4. 静态障碍物碰撞检查

**已删除的验证步骤**:
- ~~高度限制检查~~ - 原第2步验证（已删除）

## 3. 移动范围显示系统

### MoveRangeInput.gd
**文件路径**: `Scripts/MoveRangeDisplay/MoveRangeInput.gd`

**高度相关信号**:
- `height_changed(new_height: float)` (行25)
- `move_confirmed(character, target_position, target_height, movement_cost)` (行22)

**高度调整功能**:
- `_adjust_mouse_height(delta_y: float)` (行320) - 鼠标高度调整
- `_reset_to_character_height()` (行336) - 重置到角色当前高度
- `get_target_height() -> float` (行477) - 获取目标高度
- `reset_target_height()` (行610) - 重置目标高度

**已删除的移动确认中的高度检查**:
- ~~高度限制检查逻辑~~ - 原步骤4的高度限制检查（已删除）
- ~~`config.get_effective_height_limit()`调用~~ - 获取高度限制配置（已删除）

### MoveRangeRenderer.gd
**文件路径**: `Scripts/MoveRangeDisplay/MoveRangeRenderer.gd`

**已删除的高度检查功能**:
- ~~纹理生成中的高度检查~~ - `_check_height_limit_comprehensive()`调用（已删除）
- ~~CPU纹理计算中的高度检查~~ - `_validate_position_for_texture()`中的高度限制检查（已删除）
- ~~GPU块处理中的高度检查~~ - `_process_gpu_chunk_precise()`中的高度限制检查（已删除）

### MoveRangeController.gd
**文件路径**: `Scripts/MoveRangeDisplay/MoveRangeController.gd`

**已删除的快速位置验证中的高度检查**:
- ~~高度限制检查~~ - `_validate_position_fast()`中的高度限制检查（已删除）

## 4. 角色系统

### GameCharacter.gd
**文件路径**: `Scripts/Character/GameCharacter.gd`

**高度相关属性**:
- `ground_position: Vector2` (行64) - 角色地面位置(基准位置)
- `height_changed(new_height: int)` (行10) - 高度变化信号

**已删除的高度相关内容**:
- ~~`current_height: float`~~ - 当前角色高度（已删除）
- ~~`max_flight_height: float`~~ - 最大飞行高度（已删除）
- ~~`set_height(height: float)`~~ - 设置角色高度（已删除）
- ~~`get_height() -> float`~~ - 获取当前高度（已删除）
- ~~`can_reach_height(target_height: float) -> bool`~~ - 检查是否能到达指定高度（已删除）

### PlayerMovementComponent.gd
**文件路径**: `Scripts/Components/PlayerMovementComponent.gd`

**移动函数**:
- `move_to(new_position, target_height)` (行54) - 移动到指定位置和高度
- `move_requested(target_position, target_height)` (行6) - 移动请求信号

**已删除的高度相关函数**:
- ~~`_validate_movement_height(target_position: Vector2, target_height: float) -> bool`~~ - 验证移动高度（已删除）
- ~~`_check_height_accessibility(target_height: float) -> bool`~~ - 检查高度可达性（已删除）

**GroundAnchor对齐逻辑** (行128-144):
```gdscript
# 使用GroundAnchor节点计算地面对齐位置
var ground_anchor = player_node.get_node_or_null("GroundAnchor")
var ground_offset = ground_anchor.position if ground_anchor else Vector2(0, 22)

# 计算角色中心位置，使GroundAnchor对齐到目标地面位置
var character_center_pos = Vector2(base_pos.x, base_pos.y - ground_offset.y)

# 根据当前高度设置实际位置
var height_pixels = current_height_level * 40.0
player_node.position = Vector2(character_center_pos.x, character_center_pos.y - height_pixels)
```

### PlayerVisualsComponent.gd
**文件路径**: `Scripts/Components/PlayerVisualsComponent.gd`

**高度显示功能**:
- `update_height_display()` (行53) - 更新高度标签显示
- `update_modulate(height_level)` (行85) - 根据高度调整角色透明度
- 高度标签位置: `Vector2(-10, -50)` (行38)

## 5. UI组件

### PlayerUIComponent.gd
**文件路径**: `Scripts/Components/PlayerUIComponent.gd`

**工具提示中的高度信息** (行106-123):
```gdscript
func _update_tooltip_height():
    tooltip.get_node("VBoxContainer/HBoxContainer6/HeightValue").text = str(character_data.get_height_level())
    # 创建高度显示框
    var height_box = HBoxContainer.new()
    var height_label = Label.new()
    height_label.text = "高度:"
    var height_value = Label.new()
    height_value.text = str(character_data.get_height_level())
```

## 6. 管理器系统

### CharacterManager.gd
**文件路径**: `Scripts/CharacterManager.gd`

**高度检查和修正** (行348-365):
```gdscript
func check_and_fix_character_heights():
    # 检查所有角色高度是否超出轻功限制
    var height_level = character_data_obj.get_height_level()
    var qinggong_level = character_data_obj.qinggong_skill / 40
    if height_level > qinggong_level:
        character_data_obj.set_height(qinggong_level)
```

### MovementCoordinator.gd
**文件路径**: `Scripts/MovementCoordinator.gd`

**移动协调** (行92-115):
```gdscript
func _on_move_confirmed(character, target_position, target_height, movement_cost):
    if not _validate_movement(character, target_position, target_height, movement_cost):
        return
    _execute_movement(character, character_node, target_position, target_height, movement_cost)
```

## 7. 碰撞和视觉系统

### CollisionShapeDrawer.gd
**文件路径**: `Scripts/CollisionShapeDrawer.gd`

**胶囊形状高度处理** (行29-106):
```gdscript
func setup_capsule(radius: float, height: float, char_id: String):
    capsule_height = height
    # 绘制胶囊形状时考虑高度
    var rect_height = capsule_height - 2 * capsule_radius
```

## 8. 高度计算公式总结

### 基本公式
1. **目标高度计算**: `target_height = char_ground_y - target_position.y`
2. **GroundAnchor调整**: `adjusted_y = target_position.y + ground_anchor_offset.y`
3. **高度像素转换**: `height_pixels = height_level * 40.0`
4. **角色最终位置**: `final_y = character_center_y - height_pixels`

### 高度限制
- **固定地面偏移**: 30像素 (可配置)
- **轻功飞行高度**: `qinggong_skill * 0.5` (范围: 20-120像素)
- **GroundAnchor默认偏移**: 22像素

## 9. 调用关系图

```
用户输入 → MoveRangeInput
    ↓
高度检查 → PositionCollisionManager._validate_height_limit
    ↓
移动确认 → MovementCoordinator._on_move_confirmed
    ↓
执行移动 → PlayerMovementComponent.move_to
    ↓
更新显示 → PlayerVisualsComponent.update_height_display
```

## 10. 潜在问题和建议

### 发现的问题
1. **多重高度检查**: 在多个地方都有独立的高度检查逻辑，可能导致不一致
2. **显示与实际不符**: MoveRangeRenderer和实际移动验证使用不同的检查逻辑
3. **GroundAnchor偏移**: 不同地方使用不同的默认值

### 建议改进
1. **统一高度检查**: 所有高度检查都应该使用PositionCollisionManager的统一接口
2. **配置集中化**: 将所有高度相关的配置集中到MoveRangeConfig中
3. **调试信息优化**: 减少频繁触发的调试日志，改为按需输出

## 11. 文件清单

### 核心文件 (包含主要高度逻辑)
- `Scripts/PositionCollisionManager.gd` - 位置验证和高度检查
- `Scripts/MoveRangeDisplay/MoveRangeConfig.gd` - 高度配置
- `Scripts/MoveRangeDisplay/MoveRangeInput.gd` - 用户输入和高度调整
- `Scripts/Components/PlayerMovementComponent.gd` - 角色移动和GroundAnchor对齐

### 辅助文件 (包含高度相关功能)
- `Scripts/MoveRangeDisplay/MoveRangeRenderer.gd` - 移动范围纹理生成
- `Scripts/MoveRangeDisplay/MoveRangeController.gd` - 移动范围控制
- `Scripts/Character/GameCharacter.gd` - 角色数据
- `Scripts/Components/PlayerVisualsComponent.gd` - 高度显示
- `Scripts/MovementCoordinator.gd` - 移动协调
- `Scripts/CharacterManager.gd` - 角色管理

### 文档文件
- `调试测试指南.md` - GroundAnchor调试信息
- `鼠标X标记问题修复说明.md` - GroundAnchor修复说明
- `移动系统完整算法文档.md` - 移动算法文档
- `被动技能系统测试流程.md` - 飞行技能测试

---

**统计完成时间**: 2024年12月24日  
**文件总数**: 16个核心文件 + 4个文档文件  
**代码行数**: 约200+行高度相关代码