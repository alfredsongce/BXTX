# BattleScene.tscn 架构文档

## 📋 概述

BattleScene.tscn 是游戏的核心战斗场景，采用模块化设计，包含角色管理、移动系统、行动系统等多个子系统。整个场景基于 Node2D，支持2D战斗和角色移动。

## 🏗️ 场景结构树

```
战斗场景 (Node2D) [BattleScene.gd]
├── Level_1_序幕 (PackedScene实例) [level_1_序幕.tscn]
├── Players (Node) [容器节点]
├── MoveRange (Node) [移动范围系统容器]
│   ├── Config (Node) [MoveRangeConfig.gd]
│   ├── Cache (Node) [MoveRangeCache.gd]
│   ├── Validator (Node) [MoveRangeValidator.gd]
│   ├── Renderer (Node2D) [MoveRangeRenderer.gd]
│   ├── Input (Node) [MoveRangeInput.gd]
│   └── Controller (Node) [MoveRangeController.gd]
├── ActionSystem (Node) [ActionSystemNew.gd]
└── CollisionTest (Area2D) [碰撞检测区域]
```

## 🎯 核心脚本功能详解

### 1. BattleScene.gd - 主场景控制器

**功能概述**：
- 战斗场景的主控制器，负责整个战斗系统的初始化和协调
- 管理角色生成、位置设置、碰撞检测等核心功能

**主要职责**：
- **角色管理**：通过GameParty创建和管理队伍成员
- **位置管理**：设置角色初始位置和spawn点配置
- **碰撞系统**：提供高性能的碰撞检测和可视化
- **移动协调**：处理角色移动请求和移动范围系统集成
- **系统集成**：协调各子系统（移动、行动、UI等）

**关键特性**：
- 支持3个角色的队伍管理
- 优化的碰撞检测缓存系统
- 碰撞体积可视化调试功能
- 角色高度和轻功值验证

### 2. ActionSystemNew.gd - 行动系统

**功能概述**：
- 管理回合制战斗中的行动选择和执行
- 提供状态机管理不同的行动阶段

**主要职责**：
- **状态管理**：维护系统状态（空闲、选择角色、选择行动、执行行动等）
- **行动类型**：支持移动、技能、道具、特殊行动、休息等
- **移动集成**：与移动范围系统深度集成，处理移动确认
- **回合管理**：管理行动点数和回合切换

**状态流程**：
```
IDLE → SELECTING_CHARACTER → SELECTING_ACTION → SELECTING_MOVE_TARGET → EXECUTING_ACTION → IDLE
```

## 🎮 移动范围系统 (MoveRange)

移动范围系统采用组件化架构，每个组件负责特定功能：

### 3. MoveRangeController.gd - 主控制器

**功能概述**：
- 移动范围系统的核心控制器，协调所有子组件
- 提供优雅的动画效果和高性能的异步计算

**主要职责**：
- **组件协调**：管理Config、Cache、Renderer、Input、Validator等组件
- **动画控制**：提供圆形扩张动画和淡入效果
- **异步计算**：支持后台纹理计算，不阻塞UI
- **性能监控**：实时监控系统性能并自动优化
- **信号管理**：处理移动确认、取消等事件

**核心特性**：
- 🎨 优雅的UX动画（圆形扩张 + 纹理淡入）
- 🧵 多线程后台计算支持
- 📊 深度性能监控和自适应优化
- 🚀 智能缓存管理

### 4. MoveRangeConfig.gd - 配置管理

**功能概述**：
- 集中管理移动范围系统的所有配置参数
- 提供运行时配置调整和性能优化选项

**主要配置**：
- **渲染设置**：纹理分辨率、颜色配置、动画参数
- **性能选项**：GPU/CPU计算选择、缓存策略、线程设置
- **视觉效果**：边框样式、流光效果、透明度设置
- **交互设置**：鼠标响应、键盘控制、输入延迟

### 5. MoveRangeCache.gd - 缓存系统

**功能概述**：
- 高性能的纹理和计算结果缓存系统
- 支持LRU策略和智能失效机制

**主要职责**：
- **纹理缓存**：缓存生成的移动范围纹理
- **计算缓存**：缓存中间计算结果
- **内存管理**：LRU淘汰策略，防止内存泄漏
- **失效管理**：角色状态变化时智能清理相关缓存

### 6. MoveRangeValidator.gd - 验证器

**功能概述**：
- 提供精确的移动有效性验证
- 支持四重验证机制确保移动合法性

**验证层次**：
1. **圆形范围检查**：确保距离不超过轻功值
2. **高度限制检查**：确保飞行高度不超过轻功值
3. **地面限制检查**：确保不会遁地
4. **障碍物碰撞检查**：确保不与其他角色重叠

**特性**：
- 🔍 精确的胶囊体碰撞检测
- ⚡ 100ms障碍物缓存系统
- 📡 信号发射支持
- 🔄 批量验证优化

### 7. MoveRangeRenderer.gd - 渲染器

**功能概述**：
- 负责移动范围的可视化渲染
- 支持GPU/CPU双模式和丰富的视觉效果

**主要职责**：
- **纹理生成**：生成精确的移动范围纹理
- **动画渲染**：圆形扩张动画、淡入效果、流光边框
- **鼠标指示器**：动态鼠标位置指示和有效性提示
- **视觉效果**：边缘光晕、内圈光晕、彩虹色效果

**渲染特性**：
- 🎨 双色显示（绿色可移动，红色阻挡）
- ✨ 流光边框动画（3个光点120度分布）
- 🌈 鼠标指示器彩虹效果
- 🚀 GPU加速支持

### 8. MoveRangeInput.gd - 输入处理

**功能概述**：
- 处理移动范围显示期间的用户输入
- 支持鼠标和键盘的复合操作

**主要职责**：
- **鼠标处理**：鼠标移动、点击、位置验证
- **键盘处理**：高度调整（W/S键）、确认/取消
- **输入验证**：实时验证目标位置有效性
- **状态管理**：管理输入启用/禁用状态

**输入特性**：
- 🖱️ 实时鼠标位置跟踪
- ⌨️ 键盘高度调整（W/S键）
- ✅ 实时位置有效性验证
- 🎯 智能目标位置捕捉

## 🔧 系统集成与通信

### 信号系统

**MoveRangeController 信号**：
- `move_confirmed(character, target_position, target_height, movement_cost)` - 移动确认
- `move_cancelled()` - 移动取消
- `range_calculated(character, texture)` - 范围计算完成

**ActionSystem 信号**：
- 监听 `move_confirmed` 信号处理移动行动

### 组件通信

```
BattleScene.gd
    ↓ 管理
Players容器 → 角色节点
    ↓ 移动请求
MoveRangeController
    ↓ 协调
Config ← → Cache ← → Validator ← → Renderer ← → Input
    ↓ 移动确认
ActionSystem
    ↓ 行动执行
BattleScene.gd
```

## 📊 性能优化特性

### 1. 多层缓存系统
- **纹理缓存**：避免重复计算相同配置的移动范围
- **障碍物缓存**：100ms缓存减少重复扫描
- **计算结果缓存**：中间计算结果复用

### 2. 异步计算
- **后台线程**：纹理生成不阻塞主线程
- **分帧计算**：大计算量分散到多帧
- **动画掩盖**：用动画掩盖计算延迟

### 3. 自适应算法
- **性能监控**：实时监控帧率和计算时间
- **算法切换**：根据性能自动选择GPU/CPU计算
- **分辨率调整**：根据设备性能调整纹理分辨率

### 4. 内存管理
- **LRU淘汰**：自动清理最少使用的缓存
- **智能失效**：角色状态变化时精确清理相关缓存
- **内存监控**：防止内存泄漏

## 🎨 用户体验设计

### 1. 动画系统
- **圆形扩张**：显示移动范围时的优雅展开动画
- **纹理淡入**：计算完成后的平滑过渡
- **流光边框**：动态的边框光效增强视觉反馈

### 2. 交互反馈
- **实时验证**：鼠标移动时即时显示位置有效性
- **颜色编码**：绿色（可移动）、红色（阻挡）、彩虹（鼠标指示）
- **音效支持**：预留音效接口

### 3. 可访问性
- **键盘支持**：完整的键盘操作支持
- **视觉提示**：清晰的颜色和形状区分
- **性能适配**：自动适应不同设备性能

## 🔮 扩展性设计

### 1. 模块化架构
- 每个组件独立，易于替换和升级
- 清晰的接口定义，支持第三方扩展

### 2. 配置驱动
- 所有参数可配置，支持运行时调整
- 支持配置文件和编辑器调试

### 3. 插件系统
- 预留插件接口，支持自定义验证器
- 支持自定义渲染效果和动画

## 📝 开发注意事项

### 1. 性能考虑
- 移动范围计算是CPU密集型操作，需要合理使用缓存
- 大地图或多角色场景需要特别注意内存使用

### 2. 调试支持
- 所有组件都有详细的日志输出
- 支持碰撞体积可视化调试
- 性能监控数据可实时查看

### 3. 维护建议
- 定期清理缓存避免内存泄漏
- 监控性能指标及时优化
- 保持组件间接口的稳定性

---

*文档版本：1.0*  
*最后更新：2025-05-25*  
*维护者：移动系统开发团队* 