# è§’è‰²ç¼©æ”¾ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ“‹ **ç³»ç»Ÿæ¦‚è¿°**

æœ¬ç³»ç»Ÿæä¾›äº†ä¸€å¥—å®‰å…¨çš„è§’è‰²ç¼©æ”¾è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡åˆ†ç¦»å¼å¤„ç†å„ä¸ªç»„ä»¶æ¥é¿å…ç‰©ç†ç³»ç»Ÿæ··ä¹±ã€‚ä¸ç›´æ¥ç¼©æ”¾æ•´ä¸ªè§’è‰²èŠ‚ç‚¹ä¸åŒï¼Œè¯¥ç³»ç»Ÿåˆ†åˆ«å¤„ç†è§†è§‰ã€ç¢°æ’å’Œé”šç‚¹ç»„ä»¶ã€‚

### ğŸ¯ **è®¾è®¡åŸç†**

- **åˆ†ç¦»å¼ç¼©æ”¾**ï¼šé¿å…Node2Dæ•´ä½“ç¼©æ”¾å¯¼è‡´çš„Transform2Dæ··ä¹±
- **ç»„ä»¶ç‹¬ç«‹å¤„ç†**ï¼šè§†è§‰ã€ç¢°æ’ã€é”šç‚¹å„è‡ªæŒ‰éœ€ç¼©æ”¾
- **ç‰©ç†ç³»ç»Ÿç¨³å®šæ€§**ï¼šç¡®ä¿ç¢°æ’æ£€æµ‹å’Œç§»åŠ¨åŠŸèƒ½æ­£å¸¸å·¥ä½œ

---

## ğŸš€ **å¿«é€Ÿä½¿ç”¨æ–¹æ³•**

### æ–¹æ³•1ï¼šåœºæ™¯é…ç½®ï¼ˆæœ€æ¨èï¼‰â­

åœ¨è§’è‰²çš„tscnæ–‡ä»¶ä¸­æ·»åŠ `CharacterScaleConfig`èŠ‚ç‚¹ï¼š

1. **æ‰“å¼€è§’è‰²åœºæ™¯æ–‡ä»¶**ï¼ˆå¦‚Player.tscnï¼‰
2. **æ·»åŠ å­èŠ‚ç‚¹**ï¼šå³é”®æ ¹èŠ‚ç‚¹ â†’ Add Child â†’ CharacterScaleConfig
3. **é…ç½®ç¼©æ”¾å‚æ•°**ï¼šåœ¨Inspectorä¸­è®¾ç½®scale_factorï¼ˆå¦‚è§‰è¿œè®¾ä¸º3.0ï¼ŒæŸ³ç”Ÿè®¾ä¸º2.0ï¼‰
4. **ä¿å­˜åœºæ™¯**

```
Player (Node2D)
â”œâ”€â”€ Graphic (Node2D)
â”œâ”€â”€ CharacterArea (Area2D)
â”œâ”€â”€ GroundAnchor (Node2D)
â””â”€â”€ CharacterScaleConfig (Node)  â† æ–°æ·»åŠ 
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ¯ä¸ªè§’è‰²å¯ä»¥æœ‰ç‹¬ç«‹çš„ç¼©æ”¾è®¾ç½®
- âœ… åœ¨ç¼–è¾‘å™¨ä¸­å¯è§†åŒ–é…ç½®ï¼Œæ‰€è§å³æ‰€å¾—
- âœ… è‡ªåŠ¨åº”ç”¨ï¼Œæ— éœ€ç¼–å†™ä»£ç 
- âœ… æ”¯æŒç¼–è¾‘å™¨å®æ—¶é¢„è§ˆ

### æ–¹æ³•2ï¼šé€šè¿‡å…¨å±€è®¾ç½®

```gdscript
# è°ƒæ•´å…¨å±€ç¼©æ”¾å€æ•°ï¼ˆå½±å“æ‰€æœ‰æ–°åˆ›å»ºçš„è§’è‰²ï¼‰
GameSettings.set_character_scale(2.5)  # è®¾ç½®ä¸º2.5å€

# å¯¹ç°æœ‰è§’è‰²åº”ç”¨ç¼©æ”¾
GameSettings.apply_character_scale(character_node)
```

### æ–¹æ³•3ï¼šä»£ç ç›´æ¥è°ƒç”¨ï¼ˆé«˜çº§ç”¨æˆ·ï¼‰

```gdscript
# ç›´æ¥å¯¹ç‰¹å®šè§’è‰²åº”ç”¨ç¼©æ”¾
var scale_factor = 3.0
_apply_character_scale_manual(character_node, scale_factor)
```

---

## ğŸ›ï¸ **CharacterScaleConfigé…ç½®é€‰é¡¹**

### åŸºç¡€è®¾ç½®
- **Scale Factor** (0.1-5.0)ï¼šç¼©æ”¾å€æ•°ï¼Œä¾‹å¦‚3.0è¡¨ç¤º3å€å¤§å°
- **Auto Apply On Ready**ï¼šåœºæ™¯åŠ è½½æ—¶è‡ªåŠ¨åº”ç”¨ç¼©æ”¾
- **Override Global Scale**ï¼šæ˜¯å¦è¦†ç›–å…¨å±€ç¼©æ”¾è®¾ç½®

### é«˜çº§è®¾ç½®
- **Custom Anchor Offset**ï¼šè‡ªå®šä¹‰é”šç‚¹åç§»
- **Scale Visual Only**ï¼šä»…ç¼©æ”¾è§†è§‰éƒ¨åˆ†ï¼ˆä¸æ¨èï¼‰
- **Preserve Collision Shape**ï¼šä¿æŒç¢°æ’ä½“åŸå§‹å¤§å°

### ä½¿ç”¨ç¤ºä¾‹

```
è§‰è¿œè§’è‰²é…ç½®ï¼š
â”œâ”€â”€ Scale Factor: 3.0
â”œâ”€â”€ Auto Apply On Ready: âœ“
â””â”€â”€ Override Global Scale: âœ“

æŸ³ç”Ÿè§’è‰²é…ç½®ï¼š
â”œâ”€â”€ Scale Factor: 2.0
â”œâ”€â”€ Auto Apply On Ready: âœ“
â””â”€â”€ Override Global Scale: âœ“
```

---

## ğŸ”§ **æŠ€æœ¯å®ç°ç»†èŠ‚**

### æ ¸å¿ƒå‡½æ•°ï¼š`apply_character_scale()`

è¯¥å‡½æ•°ä½äº `Scripts/Managers/GameSettings.gd` ä¸­ï¼Œè´Ÿè´£æ‰§è¡Œåˆ†ç¦»å¼ç¼©æ”¾ï¼š

```gdscript
func apply_character_scale(character_node: Node2D) -> void:
    if not character_node:
        return
    
    # 1. ç¼©æ”¾è§†è§‰éƒ¨åˆ†
    var graphic_node = character_node.get_node_or_null("Graphic")
    if graphic_node:
        graphic_node.scale = Vector2(character_scale, character_scale)
        print("ğŸ¨ [GameSettings] å·²ç¼©æ”¾è§†è§‰ç»„ä»¶ %.1f å€" % character_scale)
    
    # 2. ç¼©æ”¾ç¢°æ’ä½“ï¼ˆä¿æŒç‰©ç†ä¸€è‡´æ€§ï¼‰
    var character_area = character_node.get_node_or_null("CharacterArea")
    if character_area:
        var collision_shape = character_area.get_node_or_null("CollisionShape2D")
        if collision_shape and collision_shape.shape:
            _scale_collision_shape(collision_shape.shape, character_scale)
            print("ğŸ¨ [GameSettings] å·²ç¼©æ”¾ç¢°æ’ä½“ç»„ä»¶ %.1f å€" % character_scale)
    
    # 3. ç¼©æ”¾GroundAnchorä½ç½®
    var ground_anchor = character_node.get_node_or_null("GroundAnchor")
    if ground_anchor:
        var original_position = Vector2(0, 22)  # æ ¹æ®å®é™…è°ƒæ•´
        ground_anchor.position = original_position * character_scale
        print("ğŸ¨ [GameSettings] å·²è°ƒæ•´GroundAnchorä½ç½® %.1f å€" % character_scale)
```

### ç¢°æ’å½¢çŠ¶ç¼©æ”¾å‡½æ•°ï¼š`_scale_collision_shape()`

```gdscript
func _scale_collision_shape(shape: Shape2D, scale_factor: float) -> void:
    if shape is CapsuleShape2D:
        var capsule = shape as CapsuleShape2D
        # ä¿å­˜åŸå§‹å€¼ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ä¿å­˜çš„è¯ï¼‰
        if not capsule.has_meta("original_radius"):
            capsule.set_meta("original_radius", capsule.radius)
            capsule.set_meta("original_height", capsule.height)
        
        # åº”ç”¨ç¼©æ”¾
        capsule.radius = capsule.get_meta("original_radius") * scale_factor
        capsule.height = capsule.get_meta("original_height") * scale_factor
        
    elif shape is CircleShape2D:
        var circle = shape as CircleShape2D
        if not circle.has_meta("original_radius"):
            circle.set_meta("original_radius", circle.radius)
        circle.radius = circle.get_meta("original_radius") * scale_factor
        
    elif shape is RectangleShape2D:
        var rect = shape as RectangleShape2D
        if not rect.has_meta("original_size"):
            rect.set_meta("original_size", rect.size)
        rect.size = rect.get_meta("original_size") * scale_factor
```

---

## âš ï¸ **é‡è¦æ³¨æ„äº‹é¡¹**

### ğŸš¨ **ç»å¯¹ç¦æ­¢çš„æ“ä½œ**

```gdscript
# âŒ ç»å¯¹ä¸è¦è¿™æ ·åšï¼
character_node.scale = Vector2(2.0, 2.0)  # ä¼šå¯¼è‡´ç‰©ç†ç³»ç»Ÿæ··ä¹±

# âŒ ä¸è¦ç›´æ¥ä¿®æ”¹ç¢°æ’å½¢çŠ¶å¤§å°è€Œä¸ä¿å­˜åŸå§‹å€¼
collision_shape.shape.radius *= 2.0  # æ— æ³•è¿˜åŸ
```

### âœ… **æ­£ç¡®çš„æ“ä½œæ–¹å¼**

```gdscript
# âœ… ä½¿ç”¨ç³»ç»Ÿæä¾›çš„æ¥å£
GameSettings.apply_character_scale(character_node)

# âœ… ä¿®æ”¹å…¨å±€è®¾ç½®åé‡æ–°åˆ›å»ºè§’è‰²
GameSettings.set_character_scale(2.0)
# ç„¶åé‡æ–°åŠ è½½å…³å¡æˆ–åˆ›å»ºè§’è‰²
```

### ğŸ“‹ **å¿…é¡»çš„èŠ‚ç‚¹ç»“æ„**

ç¡®ä¿ä½ çš„è§’è‰²èŠ‚ç‚¹å…·æœ‰ä»¥ä¸‹ç»“æ„ï¼š
```
CharacterNode (Node2D)
â”œâ”€â”€ Graphic (Node2D)                    # è§†è§‰ç»„ä»¶
â”œâ”€â”€ CharacterArea (Area2D)               # ç¢°æ’åŒºåŸŸ
â”‚   â””â”€â”€ CollisionShape2D                 # ç¢°æ’å½¢çŠ¶
â””â”€â”€ GroundAnchor (Node2D)               # åœ°é¢é”šç‚¹
```

---

## ğŸ› ï¸ **è‡ªå®šä¹‰ç¼©æ”¾å®ç°**

### ä¸ºç‰¹å®šè§’è‰²åˆ›å»ºè‡ªå®šä¹‰ç¼©æ”¾

```gdscript
func apply_custom_scale_to_character(character_node: Node2D, scale_factor: float):
    if not character_node:
        print("âŒ è§’è‰²èŠ‚ç‚¹ä¸ºç©º")
        return
    
    # 1. æ£€æŸ¥èŠ‚ç‚¹ç»“æ„
    if not _validate_character_structure(character_node):
        print("âŒ è§’è‰²èŠ‚ç‚¹ç»“æ„ä¸å®Œæ•´")
        return
    
    # 2. ä¿å­˜å½“å‰ç¼©æ”¾çŠ¶æ€
    character_node.set_meta("custom_scale_factor", scale_factor)
    
    # 3. åº”ç”¨è§†è§‰ç¼©æ”¾
    var graphic_node = character_node.get_node("Graphic")
    graphic_node.scale = Vector2(scale_factor, scale_factor)
    
    # 4. åº”ç”¨ç¢°æ’ä½“ç¼©æ”¾
    var collision_shape = character_node.get_node("CharacterArea/CollisionShape2D")
    _apply_collision_scale(collision_shape, scale_factor)
    
    # 5. è°ƒæ•´é”šç‚¹
    var ground_anchor = character_node.get_node("GroundAnchor")
    _adjust_ground_anchor(ground_anchor, scale_factor)
    
    print("âœ… å·²ä¸ºè§’è‰² %s åº”ç”¨ %.1f å€ç¼©æ”¾" % [character_node.name, scale_factor])

func _validate_character_structure(character_node: Node2D) -> bool:
    var required_paths = [
        "Graphic",
        "CharacterArea",
        "CharacterArea/CollisionShape2D",
        "GroundAnchor"
    ]
    
    for path in required_paths:
        if not character_node.has_node(path):
            print("âŒ ç¼ºå¤±å¿…è¦èŠ‚ç‚¹: %s" % path)
            return false
    
    return true
```

---

## ğŸ” **æ•…éšœæ’é™¤**

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### é—®é¢˜1ï¼šç¼©æ”¾åç§»åŠ¨åŠŸèƒ½å¼‚å¸¸
**ç—‡çŠ¶**ï¼šè§’è‰²ç§»åŠ¨ä¸€æ®µæ—¶é—´åæ— æ³•æ­£å¸¸ç§»åŠ¨ï¼Œæˆ–èƒ½èµ°åˆ°éšœç¢ç‰©ä¸Š
**åŸå› **ï¼šä½¿ç”¨äº†Node2D.scaleè€Œéåˆ†ç¦»å¼ç¼©æ”¾
**è§£å†³**ï¼š
```gdscript
# é‡ç½®è§’è‰²ç¼©æ”¾
character_node.scale = Vector2(1.0, 1.0)
# ä½¿ç”¨æ­£ç¡®çš„æ–¹æ³•é‡æ–°ç¼©æ”¾
GameSettings.apply_character_scale(character_node)
```

#### é—®é¢˜2ï¼šç¢°æ’ä½“é¢„è§ˆå¤§å°ä¸æ­£ç¡®
**ç—‡çŠ¶**ï¼šåœ¨ç¼–è¾‘å™¨ä¸­çœ‹åˆ°çš„ç¢°æ’ä½“ä¸å®é™…å¤§å°ä¸ç¬¦
**åŸå› **ï¼šç›´æ¥ä¿®æ”¹äº†Shape2Då±æ€§ï¼Œç¼–è¾‘å™¨éœ€è¦åˆ·æ–°
**è§£å†³**ï¼š
```gdscript
# å¼ºåˆ¶åˆ·æ–°ç¢°æ’ä½“æ˜¾ç¤º
collision_shape.shape.emit_changed()
```

#### é—®é¢˜3ï¼šç¼©æ”¾åæ— æ³•è¿˜åŸåˆ°åŸå§‹å¤§å°
**ç—‡çŠ¶**ï¼šè®¾ç½®ç¼©æ”¾ä¸º1.0åè§’è‰²ä»ç„¶å¾ˆå¤§
**åŸå› **ï¼šå…ƒæ•°æ®ä¸¢å¤±æˆ–è¢«è¦†ç›–
**è§£å†³**ï¼š
```gdscript
# æ¸…é™¤å…ƒæ•°æ®å¹¶é‡æ–°è®¾ç½®
func reset_character_scale(character_node: Node2D):
    var collision_shape = character_node.get_node("CharacterArea/CollisionShape2D")
    var shape = collision_shape.shape
    
    # æ¸…é™¤æ‰€æœ‰ç¼©æ”¾ç›¸å…³çš„å…ƒæ•°æ®
    shape.remove_meta("original_radius")
    shape.remove_meta("original_height")
    shape.remove_meta("original_size")
    
    # é‡æ–°åº”ç”¨æ­£ç¡®çš„ç¼©æ”¾
    GameSettings.apply_character_scale(character_node)
```

---

## ğŸ“š **æœ€ä½³å®è·µ**

### 1. ç¼©æ”¾æ—¶æœº
```gdscript
# âœ… æœ€ä½³ï¼šåœ¨è§’è‰²åˆ›å»ºåç«‹å³ç¼©æ”¾
func create_character():
    var character = load_character_scene()
    add_child(character)
    GameSettings.apply_character_scale(character)  # åˆ›å»ºåç«‹å³ç¼©æ”¾

# âŒ é¿å…ï¼šè§’è‰²å·²ç»å¼€å§‹ç§»åŠ¨åå†ç¼©æ”¾
```

### 2. æ‰¹é‡ç¼©æ”¾
```gdscript
# âœ… æ‰¹é‡å¤„ç†å¤šä¸ªè§’è‰²
func scale_all_characters(scale_factor: float):
    GameSettings.set_character_scale(scale_factor)
    
    var characters = get_tree().get_nodes_in_group("characters")
    for character in characters:
        GameSettings.apply_character_scale(character)
```

### 3. ä¿å­˜ç¼©æ”¾çŠ¶æ€
```gdscript
# âœ… åœ¨å­˜æ¡£ä¸­ä¿å­˜ç¼©æ”¾è®¾ç½®
func save_game_settings():
    var settings = {
        "character_scale": GameSettings.get_character_scale(),
        # å…¶ä»–è®¾ç½®...
    }
    # ä¿å­˜åˆ°æ–‡ä»¶...

func load_game_settings(settings: Dictionary):
    if settings.has("character_scale"):
        GameSettings.set_character_scale(settings.character_scale)
```

---

## ğŸ”§ **é«˜çº§é…ç½®**

### é’ˆå¯¹ä¸åŒè§’è‰²ç±»å‹çš„ç¼©æ”¾

```gdscript
# æ ¹æ®è§’è‰²ç±»å‹åº”ç”¨ä¸åŒç¼©æ”¾
func apply_type_specific_scale(character_node: Node2D):
    var character_data = character_node.get_character_data()
    var scale_factor = 1.0
    
    match character_data.character_type:
        "boss":
            scale_factor = 2.5  # BOSSæ›´å¤§
        "normal_enemy":
            scale_factor = 1.5  # æ™®é€šæ•Œäººç¨å¤§
        "player":
            scale_factor = 2.0  # ç©å®¶è§’è‰²
    
    # ä¿å­˜è§’è‰²ä¸“ç”¨ç¼©æ”¾
    character_node.set_meta("type_scale", scale_factor)
    GameSettings.apply_character_scale(character_node)
```

### åŠ¨æ€ç¼©æ”¾è°ƒæ•´

```gdscript
# æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€è°ƒæ•´ç¼©æ”¾
func adjust_character_scale_runtime(character_node: Node2D, new_scale: float):
    # å…ˆæ¸…é™¤ä¹‹å‰çš„ç¼©æ”¾çŠ¶æ€
    reset_character_scale(character_node)
    
    # åº”ç”¨æ–°çš„ç¼©æ”¾
    var old_scale = GameSettings.get_character_scale()
    GameSettings.set_character_scale(new_scale)
    GameSettings.apply_character_scale(character_node)
    GameSettings.set_character_scale(old_scale)  # æ¢å¤å…¨å±€è®¾ç½®
```

---

## ğŸ“ **æŠ€æœ¯æ”¯æŒ**

### è°ƒè¯•ä¿¡æ¯è¾“å‡º

åœ¨ `GameSettings.gd` ä¸­å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼š
```gdscript
# åœ¨ç¼©æ”¾å‡½æ•°ä¸­æŸ¥çœ‹è¿™äº›æ—¥å¿—ç¡®è®¤æ“ä½œ
print("ğŸ¨ [GameSettings] å·²ç¼©æ”¾è§†è§‰ç»„ä»¶ %.1f å€" % character_scale)
print("ğŸ¨ [GameSettings] å·²ç¼©æ”¾ç¢°æ’ä½“ç»„ä»¶ %.1f å€" % character_scale)
print("ğŸ¨ [GameSettings] å·²è°ƒæ•´GroundAnchorä½ç½® %.1f å€" % character_scale)
```

### ç³»ç»Ÿå¥åº·æ£€æŸ¥

```gdscript
func check_scaling_system_health():
    print("ğŸ” ç¼©æ”¾ç³»ç»Ÿå¥åº·æ£€æŸ¥:")
    print("  - å½“å‰å…¨å±€ç¼©æ”¾: %.1f" % GameSettings.get_character_scale())
    print("  - GameSettingsæ˜¯å¦å¯ç”¨: %s" % (GameSettings != null))
    
    var characters = get_tree().get_nodes_in_group("characters")
    print("  - åœºæ™¯ä¸­è§’è‰²æ•°é‡: %d" % characters.size())
    
    for character in characters:
        var has_meta = character.get_node("CharacterArea/CollisionShape2D").shape.has_meta("original_radius")
        print("    - %s: å…ƒæ•°æ®çŠ¶æ€: %s" % [character.name, "æ­£å¸¸" if has_meta else "ç¼ºå¤±"])
```

---

## âœ… **æ€»ç»“æ£€æŸ¥æ¸…å•**

ä½¿ç”¨å‰è¯·ç¡®è®¤ï¼š

- [ ] è§’è‰²èŠ‚ç‚¹å…·æœ‰å®Œæ•´çš„ç»“æ„ï¼ˆGraphicã€CharacterAreaã€GroundAnchorï¼‰
- [ ] ä½¿ç”¨ `GameSettings.apply_character_scale()` è€Œéç›´æ¥ç¼©æ”¾
- [ ] åœ¨è§’è‰²åˆ›å»ºåç«‹å³åº”ç”¨ç¼©æ”¾
- [ ] é¿å…é‡å¤ç¼©æ”¾åŒä¸€è§’è‰²
- [ ] æµ‹è¯•ç§»åŠ¨åŠŸèƒ½æ˜¯å¦æ­£å¸¸
- [ ] ç¡®è®¤ç¢°æ’æ£€æµ‹å·¥ä½œæ­£ç¡®

**è®°ä½ï¼šåˆ†ç¦»å¼ç¼©æ”¾æ˜¯ä¿æŒç³»ç»Ÿç¨³å®šçš„å…³é”®ï¼** 