# 角色缩放系统使用指南

## 📋 **系统概述**

本系统提供了一套安全的角色缩放解决方案，通过分离式处理各个组件来避免物理系统混乱。与直接缩放整个角色节点不同，该系统分别处理视觉、碰撞和锚点组件。

### 🎯 **设计原理**

- **分离式缩放**：避免Node2D整体缩放导致的Transform2D混乱
- **组件独立处理**：视觉、碰撞、锚点各自按需缩放
- **物理系统稳定性**：确保碰撞检测和移动功能正常工作

---

## 🚀 **快速使用方法**

### 方法1：场景配置（最推荐）⭐

在角色的tscn文件中添加`CharacterScaleConfig`节点：

1. **打开角色场景文件**（如Player.tscn）
2. **添加子节点**：右键根节点 → Add Child → CharacterScaleConfig
3. **配置缩放参数**：在Inspector中设置scale_factor（如觉远设为3.0，柳生设为2.0）
4. **保存场景**

```
Player (Node2D)
├── Graphic (Node2D)
├── CharacterArea (Area2D)
├── GroundAnchor (Node2D)
└── CharacterScaleConfig (Node)  ← 新添加
```

**优势**：
- ✅ 每个角色可以有独立的缩放设置
- ✅ 在编辑器中可视化配置，所见即所得
- ✅ 自动应用，无需编写代码
- ✅ 支持编辑器实时预览

### 方法2：通过全局设置

```gdscript
# 调整全局缩放倍数（影响所有新创建的角色）
GameSettings.set_character_scale(2.5)  # 设置为2.5倍

# 对现有角色应用缩放
GameSettings.apply_character_scale(character_node)
```

### 方法3：代码直接调用（高级用户）

```gdscript
# 直接对特定角色应用缩放
var scale_factor = 3.0
_apply_character_scale_manual(character_node, scale_factor)
```

---

## 🎛️ **CharacterScaleConfig配置选项**

### 基础设置
- **Scale Factor** (0.1-5.0)：缩放倍数，例如3.0表示3倍大小
- **Auto Apply On Ready**：场景加载时自动应用缩放
- **Override Global Scale**：是否覆盖全局缩放设置

### 高级设置
- **Custom Anchor Offset**：自定义锚点偏移
- **Scale Visual Only**：仅缩放视觉部分（不推荐）
- **Preserve Collision Shape**：保持碰撞体原始大小

### 使用示例

```
觉远角色配置：
├── Scale Factor: 3.0
├── Auto Apply On Ready: ✓
└── Override Global Scale: ✓

柳生角色配置：
├── Scale Factor: 2.0
├── Auto Apply On Ready: ✓
└── Override Global Scale: ✓
```

---

## 🔧 **技术实现细节**

### 核心函数：`apply_character_scale()`

该函数位于 `Scripts/Managers/GameSettings.gd` 中，负责执行分离式缩放：

```gdscript
func apply_character_scale(character_node: Node2D) -> void:
    if not character_node:
        return
    
    # 1. 缩放视觉部分
    var graphic_node = character_node.get_node_or_null("Graphic")
    if graphic_node:
        graphic_node.scale = Vector2(character_scale, character_scale)
        print("🎨 [GameSettings] 已缩放视觉组件 %.1f 倍" % character_scale)
    
    # 2. 缩放碰撞体（保持物理一致性）
    var character_area = character_node.get_node_or_null("CharacterArea")
    if character_area:
        var collision_shape = character_area.get_node_or_null("CollisionShape2D")
        if collision_shape and collision_shape.shape:
            _scale_collision_shape(collision_shape.shape, character_scale)
            print("🎨 [GameSettings] 已缩放碰撞体组件 %.1f 倍" % character_scale)
    
    # 3. 缩放GroundAnchor位置
    var ground_anchor = character_node.get_node_or_null("GroundAnchor")
    if ground_anchor:
        var original_position = Vector2(0, 22)  # 根据实际调整
        ground_anchor.position = original_position * character_scale
        print("🎨 [GameSettings] 已调整GroundAnchor位置 %.1f 倍" % character_scale)
```

### 碰撞形状缩放函数：`_scale_collision_shape()`

```gdscript
func _scale_collision_shape(shape: Shape2D, scale_factor: float) -> void:
    if shape is CapsuleShape2D:
        var capsule = shape as CapsuleShape2D
        # 保存原始值（如果还没有保存的话）
        if not capsule.has_meta("original_radius"):
            capsule.set_meta("original_radius", capsule.radius)
            capsule.set_meta("original_height", capsule.height)
        
        # 应用缩放
        capsule.radius = capsule.get_meta("original_radius") * scale_factor
        capsule.height = capsule.get_meta("original_height") * scale_factor
        
    elif shape is CircleShape2D:
        var circle = shape as CircleShape2D
        if not circle.has_meta("original_radius"):
            circle.set_meta("original_radius", circle.radius)
        circle.radius = circle.get_meta("original_radius") * scale_factor
        
    elif shape is RectangleShape2D:
        var rect = shape as RectangleShape2D
        if not rect.has_meta("original_size"):
            rect.set_meta("original_size", rect.size)
        rect.size = rect.get_meta("original_size") * scale_factor
```

---

## ⚠️ **重要注意事项**

### 🚨 **绝对禁止的操作**

```gdscript
# ❌ 绝对不要这样做！
character_node.scale = Vector2(2.0, 2.0)  # 会导致物理系统混乱

# ❌ 不要直接修改碰撞形状大小而不保存原始值
collision_shape.shape.radius *= 2.0  # 无法还原
```

### ✅ **正确的操作方式**

```gdscript
# ✅ 使用系统提供的接口
GameSettings.apply_character_scale(character_node)

# ✅ 修改全局设置后重新创建角色
GameSettings.set_character_scale(2.0)
# 然后重新加载关卡或创建角色
```

### 📋 **必须的节点结构**

确保你的角色节点具有以下结构：
```
CharacterNode (Node2D)
├── Graphic (Node2D)                    # 视觉组件
├── CharacterArea (Area2D)               # 碰撞区域
│   └── CollisionShape2D                 # 碰撞形状
└── GroundAnchor (Node2D)               # 地面锚点
```

---

## 🛠️ **自定义缩放实现**

### 为特定角色创建自定义缩放

```gdscript
func apply_custom_scale_to_character(character_node: Node2D, scale_factor: float):
    if not character_node:
        print("❌ 角色节点为空")
        return
    
    # 1. 检查节点结构
    if not _validate_character_structure(character_node):
        print("❌ 角色节点结构不完整")
        return
    
    # 2. 保存当前缩放状态
    character_node.set_meta("custom_scale_factor", scale_factor)
    
    # 3. 应用视觉缩放
    var graphic_node = character_node.get_node("Graphic")
    graphic_node.scale = Vector2(scale_factor, scale_factor)
    
    # 4. 应用碰撞体缩放
    var collision_shape = character_node.get_node("CharacterArea/CollisionShape2D")
    _apply_collision_scale(collision_shape, scale_factor)
    
    # 5. 调整锚点
    var ground_anchor = character_node.get_node("GroundAnchor")
    _adjust_ground_anchor(ground_anchor, scale_factor)
    
    print("✅ 已为角色 %s 应用 %.1f 倍缩放" % [character_node.name, scale_factor])

func _validate_character_structure(character_node: Node2D) -> bool:
    var required_paths = [
        "Graphic",
        "CharacterArea",
        "CharacterArea/CollisionShape2D",
        "GroundAnchor"
    ]
    
    for path in required_paths:
        if not character_node.has_node(path):
            print("❌ 缺失必要节点: %s" % path)
            return false
    
    return true
```

---

## 🔍 **故障排除**

### 常见问题及解决方案

#### 问题1：缩放后移动功能异常
**症状**：角色移动一段时间后无法正常移动，或能走到障碍物上
**原因**：使用了Node2D.scale而非分离式缩放
**解决**：
```gdscript
# 重置角色缩放
character_node.scale = Vector2(1.0, 1.0)
# 使用正确的方法重新缩放
GameSettings.apply_character_scale(character_node)
```

#### 问题2：碰撞体预览大小不正确
**症状**：在编辑器中看到的碰撞体与实际大小不符
**原因**：直接修改了Shape2D属性，编辑器需要刷新
**解决**：
```gdscript
# 强制刷新碰撞体显示
collision_shape.shape.emit_changed()
```

#### 问题3：缩放后无法还原到原始大小
**症状**：设置缩放为1.0后角色仍然很大
**原因**：元数据丢失或被覆盖
**解决**：
```gdscript
# 清除元数据并重新设置
func reset_character_scale(character_node: Node2D):
    var collision_shape = character_node.get_node("CharacterArea/CollisionShape2D")
    var shape = collision_shape.shape
    
    # 清除所有缩放相关的元数据
    shape.remove_meta("original_radius")
    shape.remove_meta("original_height")
    shape.remove_meta("original_size")
    
    # 重新应用正确的缩放
    GameSettings.apply_character_scale(character_node)
```

---

## 📚 **最佳实践**

### 1. 缩放时机
```gdscript
# ✅ 最佳：在角色创建后立即缩放
func create_character():
    var character = load_character_scene()
    add_child(character)
    GameSettings.apply_character_scale(character)  # 创建后立即缩放

# ❌ 避免：角色已经开始移动后再缩放
```

### 2. 批量缩放
```gdscript
# ✅ 批量处理多个角色
func scale_all_characters(scale_factor: float):
    GameSettings.set_character_scale(scale_factor)
    
    var characters = get_tree().get_nodes_in_group("characters")
    for character in characters:
        GameSettings.apply_character_scale(character)
```

### 3. 保存缩放状态
```gdscript
# ✅ 在存档中保存缩放设置
func save_game_settings():
    var settings = {
        "character_scale": GameSettings.get_character_scale(),
        # 其他设置...
    }
    # 保存到文件...

func load_game_settings(settings: Dictionary):
    if settings.has("character_scale"):
        GameSettings.set_character_scale(settings.character_scale)
```

---

## 🔧 **高级配置**

### 针对不同角色类型的缩放

```gdscript
# 根据角色类型应用不同缩放
func apply_type_specific_scale(character_node: Node2D):
    var character_data = character_node.get_character_data()
    var scale_factor = 1.0
    
    match character_data.character_type:
        "boss":
            scale_factor = 2.5  # BOSS更大
        "normal_enemy":
            scale_factor = 1.5  # 普通敌人稍大
        "player":
            scale_factor = 2.0  # 玩家角色
    
    # 保存角色专用缩放
    character_node.set_meta("type_scale", scale_factor)
    GameSettings.apply_character_scale(character_node)
```

### 动态缩放调整

```gdscript
# 支持运行时动态调整缩放
func adjust_character_scale_runtime(character_node: Node2D, new_scale: float):
    # 先清除之前的缩放状态
    reset_character_scale(character_node)
    
    # 应用新的缩放
    var old_scale = GameSettings.get_character_scale()
    GameSettings.set_character_scale(new_scale)
    GameSettings.apply_character_scale(character_node)
    GameSettings.set_character_scale(old_scale)  # 恢复全局设置
```

---

## 📞 **技术支持**

### 调试信息输出

在 `GameSettings.gd` 中启用详细日志：
```gdscript
# 在缩放函数中查看这些日志确认操作
print("🎨 [GameSettings] 已缩放视觉组件 %.1f 倍" % character_scale)
print("🎨 [GameSettings] 已缩放碰撞体组件 %.1f 倍" % character_scale)
print("🎨 [GameSettings] 已调整GroundAnchor位置 %.1f 倍" % character_scale)
```

### 系统健康检查

```gdscript
func check_scaling_system_health():
    print("🔍 缩放系统健康检查:")
    print("  - 当前全局缩放: %.1f" % GameSettings.get_character_scale())
    print("  - GameSettings是否可用: %s" % (GameSettings != null))
    
    var characters = get_tree().get_nodes_in_group("characters")
    print("  - 场景中角色数量: %d" % characters.size())
    
    for character in characters:
        var has_meta = character.get_node("CharacterArea/CollisionShape2D").shape.has_meta("original_radius")
        print("    - %s: 元数据状态: %s" % [character.name, "正常" if has_meta else "缺失"])
```

---

## ✅ **总结检查清单**

使用前请确认：

- [ ] 角色节点具有完整的结构（Graphic、CharacterArea、GroundAnchor）
- [ ] 使用 `GameSettings.apply_character_scale()` 而非直接缩放
- [ ] 在角色创建后立即应用缩放
- [ ] 避免重复缩放同一角色
- [ ] 测试移动功能是否正常
- [ ] 确认碰撞检测工作正确

**记住：分离式缩放是保持系统稳定的关键！** 