# 移动碰撞检测优化方案

## 问题描述

当前的移动系统存在问题：角色可以移动到障碍物上，说明现有的碰撞检测算法过于复杂且存在漏洞。

## 优化方案

### 核心思路

采用**空间查询碰撞检测**的方式，简化移动合法性验证：

1. **鼠标点击位置** → **角色碰撞体中心位置**
2. **使用PhysicsShapeQueryParameters2D进行空间查询** → **检测目标位置碰撞**
3. **使用Area2D替代RigidBody** → **避免物理帧延迟问题**
4. **有碰撞** → **移动非法**，**无碰撞** → **移动合法**

### 实现步骤

#### 1. 移动请求处理（优化版）

```gdscript
func validate_move_to_position(character_node: Node2D, target_position: Vector2) -> bool:
    # 获取角色的碰撞体形状
    var character_collision = character_node.get_collision_shape()
    
    # 使用空间查询进行碰撞检测
    var has_collision = check_collision_with_space_query(character_collision.shape, target_position)
    
    return not has_collision
```

#### 2. 空间查询碰撞检测（优化版）

```gdscript
func check_collision_with_space_query(character_node: Node2D, shape: Shape2D, position: Vector2) -> bool:
    # 创建物理查询参数
    var query = PhysicsShapeQueryParameters2D.new()
    query.shape = shape
    
    # 正确处理旋转和缩放变换
    var rotation = character_node.global_rotation
    var scale = character_node.global_scale
    query.transform = Transform2D(rotation, scale, 0, position)
    
    # 设置碰撞层和掩码（只检测障碍物）
    query.collision_mask = obstacle_collision_layer
    
    # 执行空间查询
    var space_state = get_world_2d().direct_space_state
    var results = space_state.intersect_shape(query, 1)  # 只需要知道是否有碰撞
    
    return results.size() > 0
```

#### 3. Area2D预检测（优化版）

```gdscript
var last_update_frame: int = 0

func setup_movement_preview_area(character_node: Node2D) -> Area2D:
    # 创建Area2D用于实时预览
    var preview_area = Area2D.new()
    var preview_shape = CollisionShape2D.new()
    
    # 复制角色碰撞形状并正确处理变换
    var character_collision = character_node.get_collision_shape()
    preview_shape.shape = character_collision.shape.duplicate()
    
    # 正确处理缩放变换
    preview_shape.global_scale = character_node.global_scale
    preview_area.global_rotation = character_node.global_rotation
    
    preview_area.add_child(preview_shape)
    
    # 设置碰撞层（只检测障碍物）
    preview_area.collision_mask = obstacle_collision_layer
    preview_area.collision_layer = 0  # 不与其他物体产生碰撞
    
    # 连接信号用于实时反馈
    preview_area.area_entered.connect(_on_preview_collision_entered)
    preview_area.area_exited.connect(_on_preview_collision_exited)
    
    get_tree().current_scene.add_child(preview_area)
    return preview_area

func _on_preview_collision_entered(area: Area2D):
    # 添加时间戳验证，避免动态障碍物造成的瞬态不一致
    if Engine.get_frames_drawn() - last_update_frame < 2:
        return  # 跳过过于频繁的更新
    
    last_update_frame = Engine.get_frames_drawn()
    
    # 强制刷新动态障碍物位置
    get_tree().call_group("dynamic_obstacles", "update_position")
    
    # 显示红色指示器
    show_invalid_move_indicator()

func _on_preview_collision_exited(area: Area2D):
    # 添加时间戳验证
    if Engine.get_frames_drawn() - last_update_frame < 2:
        return
    
    last_update_frame = Engine.get_frames_drawn()
    
    # 显示绿色指示器
    show_valid_move_indicator()
```

### 算法优势

#### 1. **高性能**
- 使用PhysicsShapeQueryParameters2D避免遍历所有障碍物
- 直接查询物理空间，O(1)复杂度
- 无需创建临时物理体，减少内存开销

#### 2. **实时响应**
- Area2D避免物理帧延迟问题
- 即时碰撞检测和视觉反馈
- 支持鼠标悬停实时预览

#### 3. **准确可靠**
- 使用实际的碰撞体形状
- 精确反映角色的占用空间
- 避免边界计算错误

#### 4. **易于维护**
- 减少自定义算法的复杂性
- 利用引擎原生功能
- 便于调试和优化

#### 5. **扩展性强**
- 支持任意形状的碰撞体
- 可以轻松添加新的障碍物类型
- 支持动态障碍物

### 实现细节

#### 碰撞体类型支持

- **圆形碰撞体**：角色常用
- **矩形碰撞体**：建筑物、箱子等
- **胶囊碰撞体**：特殊角色形状
- **多边形碰撞体**：复杂障碍物

#### 关键技术细节

##### 1. Transform2D正确处理
```gdscript
# 错误方式：忽略旋转和缩放
query.transform = Transform2D(0, position)

# 正确方式：考虑完整变换
var rotation = character_node.global_rotation
var scale = character_node.global_scale
query.transform = Transform2D(rotation, scale, 0, position)
```

##### 2. Area2D缩放同步
```gdscript
# 确保预览区域与角色变换一致
preview_shape.global_scale = character_node.global_scale
preview_area.global_rotation = character_node.global_rotation
```

##### 3. 动态障碍物处理
```gdscript
# 时间戳验证避免频繁更新
if Engine.get_frames_drawn() - last_update_frame < 2:
    return

# 强制同步动态障碍物
get_tree().call_group("dynamic_obstacles", "update_position")
```

#### 性能优化

1. **空间查询优化**：使用PhysicsShapeQueryParameters2D替代遍历
2. **碰撞层管理**：精确设置collision_mask，只检测相关物体
3. **Area2D预检测**：实时反馈，避免物理帧延迟
4. **查询结果限制**：设置max_results=1，只需知道是否碰撞
5. **变换优化**：正确处理旋转和缩放，避免检测偏差
6. **帧率控制**：时间戳验证防止过度频繁的碰撞检测
7. **动态同步**：智能刷新动态障碍物，保证检测准确性
8. **碰撞缓存**：缓存常用位置的检测结果

### 集成方案

#### 修改现有系统

1. **MoveRangeValidator.gd**
   - 替换现有的复杂验证逻辑
   - 集成新的碰撞检测方法

2. **ObstacleManager.gd**
   - 提供障碍物查询接口
   - 支持快速碰撞检测

3. **移动系统集成**
   - 在移动确认前进行碰撞检测
   - 提供视觉反馈（红色/绿色指示）

### 测试验证

#### 测试用例

1. **基础移动**：角色移动到空地
2. **障碍物阻挡**：角色尝试移动到障碍物位置
3. **边界情况**：角色移动到障碍物边缘
4. **多障碍物**：复杂障碍物环境下的移动
5. **不同角色大小**：不同碰撞体大小的角色

#### 性能测试

- 大量障碍物场景下的检测性能
- 频繁移动请求的响应时间
- 内存使用情况监控

### 实施计划

#### 第一阶段：空间查询实现
- [ ] 实现PhysicsShapeQueryParameters2D碰撞检测
- [ ] 配置正确的碰撞层和掩码
- [ ] 集成到现有移动系统
- [ ] 基础测试验证

#### 第二阶段：Area2D预检测
- [ ] 实现Area2D实时预览系统
- [ ] 添加视觉反馈（红绿指示器）
- [ ] 鼠标悬停实时检测
- [ ] 性能优化测试

#### 第三阶段：扩展功能
- [ ] 支持更多碰撞体类型
- [ ] 动态障碍物支持
- [ ] 移动路径预测
- [ ] 碰撞结果缓存系统

## 总结

这个基于**空间查询和Area2D**的优化方案将显著提升移动验证系统的性能和响应速度：

- **PhysicsShapeQueryParameters2D**提供高效的空间查询，避免遍历所有障碍物
- **Area2D**解决物理帧延迟问题，实现实时碰撞检测和视觉反馈
- **碰撞层管理**确保精确的检测范围，提升性能
- **实时预览**为玩家提供即时的移动合法性反馈

通过这些优化，我们可以获得更准确、更高效、响应更快的移动合法性验证系统。