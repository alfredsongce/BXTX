# 角色系统优化计划

## 问题分析

### 1. 觉远初始位置过高问题
**现象**：觉远角色出现在空中而不是地面
**可能原因**：
- 觉远拥有"御剑飞行"被动技能，系统自动设置了飞行高度
- 高度设置逻辑可能有问题
- 需要检查角色高度设置的相关代码

### 2. 角色大小过小问题
**现象**：角色显示太小，视觉效果不佳
**解决方案考虑**：
- 直接修改Player.tscn的Scale可能影响：
  - 碰撞检测范围
  - 移动距离计算
  - UI元素定位
- 更好的方案：统一的角色缩放系统

### 3. 硬编码配置问题
**现象**：角色位置通过CSV配置，不直观
**问题**：
- 关卡设计师无法所见即所得地配置
- 调整位置需要反复测试坐标
- 不利于快速迭代关卡设计

## 解决方案

### 方案1：修复觉远高度问题
**目标**：让拥有飞行技能的角色默认也在地面
**步骤**：
1. 检查角色管理器中的高度设置逻辑
2. 分析飞行技能与初始高度的关系
3. 修改逻辑：飞行技能应该允许飞行，但初始状态应该在地面

### 方案2：实现统一角色缩放系统（修正版）
**目标**：提供可配置的角色显示大小，保持所有组件比例一致
**问题分析**：
- ❌ 原方案：只缩放Graphic节点会导致视觉与碰撞体不匹配
- ❌ 角色的脚会嵌入地面，GroundAnchor位置错误
- ❌ UI元素和碰撞检测出现偏差

**新方案步骤**：
1. 统一缩放整个角色节点，包括所有子组件
2. 确保碰撞体、GroundAnchor、UI元素等都按比例缩放
3. 调整相关的数值计算（如移动距离、高度计算等）
4. 提供缩放补偿机制，确保游戏逻辑正确

### 方案3：可视化关卡配置系统
**目标**：让关卡设计师可以直观配置角色位置
**步骤**：
1. 在关卡场景中添加可视化生成点节点
2. 创建生成点管理器，自动扫描场景中的生成点
3. 保持CSV作为备用方案，优先使用场景配置
4. 提供生成点类型标识（玩家/敌人）

## 实施计划

### 阶段1：问题诊断
- [x] 检查觉远高度设置的相关代码
- [x] 分析当前角色缩放机制
- [x] 调研场景节点生成点的实现方案

### 阶段2：觉远高度修复
- [x] 定位飞行技能设置高度的代码位置
- [x] 修改逻辑：区分"飞行能力"和"初始高度"
- [ ] 测试修复效果

### 阶段3：角色缩放系统
- [x] 设计全局角色缩放配置
- [x] 实现角色创建时的缩放应用
- [x] 确保缩放不影响游戏逻辑
- [x] 提供运行时调整接口

### 阶段4：可视化配置系统
- [x] 创建SpawnPoint场景节点
- [x] 实现生成点管理器
- [ ] 修改关卡初始化逻辑
- [x] 在当前关卡中添加可视化生成点

### 阶段5：测试验证
- [ ] 测试觉远高度是否正常
- [ ] 测试角色缩放效果
- [ ] 测试可视化配置是否生效
- [ ] 性能测试和优化

## 技术细节

### 角色高度管理
```gdscript
# 当前逻辑（推测）
if character.has_passive_skill("御剑飞行"):
    character.set_height(3.5)  # 自动设置飞行高度

# 目标逻辑
# 飞行技能只影响能否飞行，不影响初始位置
character.set_height(0)  # 所有角色初始都在地面
if character.has_passive_skill("御剑飞行"):
    character.can_fly = true  # 只设置飞行能力标志
```

### 角色缩放系统（最终修正版）
```gdscript
# 全局配置
var GLOBAL_CHARACTER_SCALE = 2.0

# 分离式缩放方案（避免碰撞检测混乱）
func apply_character_scale(character_node: Node2D):
    # 1. 缩放视觉部分
    var graphic_node = character_node.get_node_or_null("Graphic")
    if graphic_node:
        graphic_node.scale = Vector2(GLOBAL_CHARACTER_SCALE, GLOBAL_CHARACTER_SCALE)
    
    # 2. 直接修改碰撞形状大小（保持物理一致性）
    var collision_shape = character_node.get_node_or_null("CharacterArea/CollisionShape2D")
    if collision_shape and collision_shape.shape:
        _scale_collision_shape(collision_shape.shape, GLOBAL_CHARACTER_SCALE)
    
    # 3. 缩放GroundAnchor位置
    var ground_anchor = character_node.get_node_or_null("GroundAnchor")
    if ground_anchor:
        ground_anchor.position = original_position * GLOBAL_CHARACTER_SCALE
```

### 可视化生成点
```gdscript
# SpawnPoint.gd
class_name SpawnPoint extends Marker2D

@export var spawn_type: String = "player"  # "player" 或 "enemy"
@export var character_id: String = ""
@export var description: String = ""
```

## 预期效果

### 用户体验改善
- 觉远角色正常显示在地面
- 角色大小适中，视觉效果更佳
- 关卡设计师可以直观配置角色位置

### 开发效率提升
- 减少反复调试坐标的时间
- 提供所见即所得的配置体验
- 保持代码的可维护性

### 系统健壮性
- 统一的角色缩放管理
- 灵活的配置方案（场景优先，CSV备用）
- 不影响现有游戏逻辑

## 风险评估

### 低风险
- 角色高度修复：逻辑简单，影响范围小
- 角色缩放系统：主要是视觉效果，不影响核心逻辑

### 中等风险
- 可视化配置系统：需要修改关卡初始化流程，可能影响现有功能

### 风险缓解
- 保持现有CSV配置作为备用方案
- 分阶段实施，每个阶段独立测试
- 提供回滚方案 